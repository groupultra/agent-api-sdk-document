## Message Up

> Upward messages sent by users.

group_id is sent to moobius, specified by the user. (user-channel-groupid) maps certain user(s). Saved in db.

- One example:

```json

{
    "type": "message_up",
    "request_id": "bb6a84fe-99ab-455f-8272-6432f4053363",
    "user_id": "65202a1d-41cc-4e7b-bc6c-81fa9662076a",
    "body": {
        "subtype": "file",
        "content": {
            "path": "xxxx", // Path is acquired using upload api (http part).
            "filename": "original.txt",
            "size": xxxx
        },
        "channel_id": "50fb775a-508d-40ef-b80b-de1ef3bf791a",
        "recipients": "65202a1d-41cc-4e7b-bc6c-81fa9662076a",
        "timestamp": 1687418564123,
        "context": {}
    }
}
```

- Normal requests be like

```json
{
  "type": "message_up",
  "request_id": "bb6a84fe-99ab-455f-8272-6432f4053363",
  "user_id": "65202a1d-41cc-4e7b-bc6c-81fa9662076a",
  "body": {
    "subtype": "text",
    "content": {
      "text": "this is an example message"
    },
    "channel_id": "50fb775a-508d-40ef-b80b-de1ef3bf791a",
    "recipients": "65202a1d-41cc-4e7b-bc6c-81fa9662076a",
    "timestamp": 1687418564123,
    "context": {}
  }
}
```

| Field                     | Type   | Value                               | Desc                                            |
| ------------------------- | ------ | ----------------------------------- | ----------------------------------------------- |
| type                      | string | message_up                          | Type of the packet                              |
| request_id                | uuid   | uuid                                |                                                 |
| user_id                   | uuid   | uuid                                |
| body - subtype            | string | "text" / "file" / "audio" / "image" |                                                 |
| body - content - text     | string |                                     | Used when subtype is text                       |
| body - content - path     | string |                                     | Used when subtype is not text                   |
| body - content - filename | string |                                     | Used when subtype is file to indicate filename  |
| body - content - size     | int    |                                     | Used when subtype is file to indicate file size |
| body - channel_id         | uuid   |                                     |                                                 |
| body - recipients         | uuid   |                                     | Target users of the message                     |
| Body - message_id         | uuid   |                                     | Generated by moobius                            |
| body - timestamp          | int    |                                     | In millisecs                                    |
| body - sender             | uuid   |                                     | Added by moobius, received by service           |
| body - context            | object |                                     | Optional                                        |

- Receives a copy as response, message_id is generated and annotated by moobius

```json
{
  "type": "copy",
  "body": {
    "context": {
      "message": "Message received",
      "message_id": "d3141b6d-07ef-4189-9259-572bf41225f8"
    },
    "origin_type": "message_up",
    "request_id": "bb6a84fe-99ab-455f-8272-6432f4053363",
    "status": true
  }
}
```

- Service receive format be like

```json
{
  "type": "message_up",
  "body": {
    "subtype": "text",
    "content": {
      "text": "this is an example message"
    },
    "channel_id": "10c0133f-3fb5-4803-b40e-9bc6c516eec0",
    "timestamp": 1688481188282,
    "message_id": "d3141b6d-07ef-4189-9259-572bf41225f8",
    "sender": "d3141b6d-07ef-4189-9259-572bf41225f8",
    "recipients": "d3141b6d-07ef-4189-9259-572bf41225f8",
    "context": {}
  }
}
```

## Roger

User -> moobius to make sure a user really receives a message. Frontend must send one roger when a user really receives (and have looked into) a message. This mechanism is used to distinguish unread messages from read messages.

```json
{
  "type": "roger",
  "request_id": "120cb5bf-a2b3-4d19-b8f4-b2058d7182cc",
  "user_id": "65202a1d-41cc-4e7b-bc6c-81fa9662076a",
  "body": {
    "message_id": "50fb775a-508d-40ef-b80b-de1ef3bf791a",
    "context": {}
  }
}
```

## Heartbeat

Clients use this to keep websocket alive; servers can use this to refresh connectId expiration on redis.

- request

```json
{
  "type": "heartbeat",
  "request_id": "120cb5bf-a2b3-4d19-b8f4-b2058d7182cc",
  "body": {}
}
```

- response

```json
{
  "type": "copy",
  "body": {
    "request_id": "120cb5bf-a2b3-4d19-b8f4-b2058d7182cc",
    "origin_type": "heartbeat",
    "status": true,
    "context": {}
  }
}
```
